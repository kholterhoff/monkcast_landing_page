---
import EpisodeCard from "./EpisodeCard.astro";
import ErrorBoundary from "./ErrorBoundary.astro";
import type { Episode } from "../types";

interface Props {
  episodes: Episode[];
  isStale?: boolean;
  lastUpdated?: string;
  error?: {
    type: 'network' | 'timeout' | 'server' | 'data' | 'unknown';
    message?: string;
  };
}

const { episodes, isStale = false, lastUpdated, error } = Astro.props as Props;

// Validate episodes data
const validEpisodes = (episodes || []).filter((episode: Episode) => {
  try {
    return episode && episode.title && episode.guid;
  } catch (e) {
    console.warn('Invalid episode data:', e);
    return false;
  }
});

const hasValidEpisodes = validEpisodes.length > 0;
---

<section
  id="episodes"
  class="py-16 bg-gradient-to-b from-gray-50 to-white relative overflow-hidden"
  aria-labelledby="episodes-heading"
>
  <div
    class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-secondary-100/30 via-transparent to-transparent"
  >
  </div>
  <div class="container mx-auto px-4 relative z-10">
    <h2 id="episodes-heading" class="text-3xl font-bold mb-8 text-center text-secondary-900">
      Latest Episodes
    </h2>

    {/* Show error boundary if there are issues */}
    {error && (
      <ErrorBoundary 
        fallback={error.message || "Unable to load episodes at this time."}
        showRetry={true}
        context="episodes"
        errorType={error.type}
        isStale={isStale}
        lastUpdated={lastUpdated}
      />
    )}

    {/* Show stale data warning if applicable */}
    {isStale && !error && (
      <ErrorBoundary 
        fallback="Showing cached episodes. Some content may be outdated."
        showRetry={true}
        context="episodes"
        isStale={true}
        lastUpdated={lastUpdated}
      />
    )}

    <div class="grid gap-8">
      {hasValidEpisodes ? (
        <>
          <div class="mb-12">
            <EpisodeCard episode={validEpisodes[0]} featured={true} />
          </div>

          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 md:gap-8"
          >
            {validEpisodes.length > 1 ? (
              validEpisodes
                .slice(1, 7)
                .map((episode: Episode) => (
                  <div class="episode-card-wrapper">
                    <EpisodeCard episode={episode} />
                  </div>
                ))
            ) : (
              <div class="col-span-full text-center py-8">
                <p class="text-gray-500">Only one episode available.</p>
              </div>
            )}
          </div>

          {validEpisodes.length > 7 && (
            <div class="text-center mt-8">
              <a
                href="https://redmonk.com/blog/category/appearances/"
                class="btn inline-flex items-center gap-2 bg-gradient-to-r from-secondary-800 to-secondary-700 text-white px-6 py-3 rounded-md hover:shadow-lg hover:-translate-y-1 transition-all focus:outline-none focus:ring-2 focus:ring-secondary-500 focus:ring-offset-2"
                aria-label="View all episodes on RedMonk blog"
              >
                View All Episodes
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path d="M5 12h14" />
                  <path d="m12 5 7 7-7 7" />
                </svg>
              </a>
            </div>
          )}
        </>
      ) : (
        <div class="text-center py-12">
          <div class="max-w-md mx-auto">
            <svg
              class="mx-auto h-12 w-12 text-gray-400 mb-4"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
              />
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Episodes Available</h3>
            <p class="text-gray-500 mb-4">
              Episodes are temporarily unavailable. Please check back later.
            </p>
            <button
              onclick="window.location.reload()"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-secondary-600 hover:bg-secondary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-500"
            >
              Refresh Page
            </button>
          </div>
        </div>
      )}
    </div>
  </div>
</section>
