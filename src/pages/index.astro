---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import EpisodeList from '../components/EpisodeList.astro';
import PodcastPlayer from '../components/PodcastPlayer.astro';
import Platforms from '../components/Platforms.astro';
import YouTubeCTA from '../components/YouTubeCTA.astro';
import About from '../components/About.astro';
import Newsletter from '../components/Newsletter.astro';
import Welcome from '../components/Welcome.astro';
import Hosts from '../components/Hosts.astro';
import { fetchPodcastFeed, PODCAST_RSS_URL } from '../services/rss';
import type { Episode, Podcast } from '../types';

// Fetch podcast data with incremental build support
let podcast: Podcast;
let episodes: Episode[] = [];
let isStale = false;
let lastUpdated: string | undefined;
let error: { type: 'network' | 'timeout' | 'server' | 'data' | 'unknown'; message?: string } | undefined;

try {
  // Try incremental RSS service first for better performance
  try {
    const { fetchPodcastFeedIncremental } = await import('../services/incrementalRss.js');
    const result = await fetchPodcastFeedIncremental();
    podcast = result.podcast;
    episodes = result.episodes.slice(0, 10); // Limit to recent episodes for homepage
    isStale = result.buildInfo.cacheStats.cacheHitRate < 100;
    lastUpdated = new Date().toLocaleString();
    
    console.log(`ðŸ  Homepage: Loaded ${episodes.length} episodes via incremental service`);
  } catch (incrementalError) {
    console.warn('âš ï¸  Incremental service unavailable, using standard fetch');
    podcast = await fetchPodcastFeed(PODCAST_RSS_URL) as Podcast;
    episodes = (podcast.episodes || []).slice(0, 10);
  }
} catch (fetchError) {
  console.error('âŒ Failed to fetch podcast data for homepage:', fetchError);
  
  // Set error information for display
  if (fetchError.code === 'NETWORK_ERROR') {
    error = { type: 'network', message: 'Unable to connect to podcast feed' };
  } else if (fetchError.code === 'TIMEOUT') {
    error = { type: 'timeout', message: 'Podcast feed request timed out' };
  } else if (fetchError.status >= 500) {
    error = { type: 'server', message: 'Podcast service temporarily unavailable' };
  } else {
    error = { type: 'unknown', message: 'Unable to load podcast episodes' };
  }
  
  // Provide fallback data
  podcast = {
    title: 'The MonkCast',
    description: 'Technology analysis and insights from the RedMonk team',
    link: 'https://redmonk.com',
    image: 'https://redmonk.com/wp-content/uploads/2018/07/Monkchips-1.jpg',
    itunesAuthor: 'RedMonk',
    episodes: []
  };
  episodes = [];
}
---

<Layout title="The MonkCast - Technology analysis from RedMonk">
  <Hero podcast={podcast} />
  
  <section class="py-8 bg-gradient-to-b from-white to-gray-50 relative overflow-hidden">
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-primary-100/30 via-transparent to-transparent"></div>
    <div class="container mx-auto px-4 relative z-10">
      {episodes && episodes.length > 0 && (
        <div class="max-w-3xl mx-auto">
          <PodcastPlayer episode={episodes[0]} />
        </div>
      )}
    </div>
  </section>
  
  <Platforms />
  
  <YouTubeCTA />
  
  <EpisodeList 
    episodes={episodes} 
    isStale={isStale}
    lastUpdated={lastUpdated}
    error={error}
  />
  
  <Welcome />
  
  <About />
  
  <Hosts />
  
  <Newsletter />
</Layout>

<style>
  /* Add any additional page-specific styles here */
</style>

<script>
  // Add page animations using the motion library
  import { animate, inView, stagger } from 'motion';
  
  // Animate episode cards on scroll
  inView('article', ({ target }) => {
    animate(
      target,
      { opacity: [0, 1], y: [20, 0] },
      { duration: 0.6, delay: 0.1 }
    );
  });
  
  // Animate platforms section
  inView('#about .hover-lift', ({ target }) => {
    animate(
      target,
      { opacity: [0, 1], scale: [0.9, 1] },
      { duration: 0.5, delay: stagger(0.1) }
    );
  }, { margin: "0px 0px -100px 0px" });
</script>